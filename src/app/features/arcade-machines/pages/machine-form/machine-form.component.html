<!-- src/app/features/arcade-machines/pages/machine-form/machine-form.component.html -->

<div class="page-container animate-fade-in">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-desktop neon-glow"></i>
        {{ pageTitle() }}
      </h1>
      <p class="page-subtitle">
        {{ isEditMode() ? 'Modifiez les informations et la configuration' : 'Créez une nouvelle borne d\'arcade' }}
      </p>
    </div>
  </div>

  <div class="form-container">
    @if (loading()) {
      <app-loader size="large">
        <div class="loading-content">
          <i class="pi pi-spin pi-cog loading-icon"></i>
          <span>{{ isEditMode() ? 'Chargement de la borne...' : 'Chargement du formulaire...' }}</span>
        </div>
      </app-loader>
    } @else {
      <form [formGroup]="machineForm" (ngSubmit)="handleSubmit()" class="machine-form">
        
        <!-- Section informations générales -->
        <p-card header="Informations générales" styleClass="form-section">
          <ng-template pTemplate="header">
            <div class="section-header">
              <i class="pi pi-info-circle"></i>
              <span>Informations générales</span>
            </div>
          </ng-template>
          
          <div class="form-grid">
            <!-- Nom de la borne -->
            <div class="form-group col-12">
              <label for="nom" class="required">Nom de la borne</label>
              <input 
                id="nom" 
                type="text" 
                pInputText 
                formControlName="nom"
                [class.ng-invalid]="isFieldInvalid('nom')"
                placeholder="Ex: Borne Rétro Zone 1"
                class="gaming-input" />
              @if (isFieldInvalid('nom')) {
                <small class="p-error">Le nom de la borne est requis (minimum 2 caractères)</small>
              }
            </div>

            <!-- Description -->
            <div class="form-group col-12">
              <label for="description">Description</label>
              <textarea 
                id="description" 
                pInputTextarea 
                formControlName="description"
                rows="3" 
                placeholder="Description de la borne (optionnel)"
                class="gaming-input">
              </textarea>
            </div>

            <!-- Clé API -->
            <div class="form-group col-12">
              <label for="api_key" class="required">Clé API</label>
              <div class="api-key-container">
                <input 
                  id="api_key" 
                  type="text" 
                  pInputText 
                  formControlName="api_key"
                  [class.ng-invalid]="isFieldInvalid('api_key')"
                  placeholder="Clé API générée automatiquement"
                  readonly
                  class="gaming-input api-key-input" />
                <button 
                  type="button"
                  pButton 
                  pRipple 
                  icon="pi pi-refresh" 
                  label="Générer"
                  severity="secondary"
                  outlined
                  (click)="generateNewApiKey()"
                  class="api-key-btn">
                </button>
              </div>
              @if (isFieldInvalid('api_key')) {
                <small class="p-error">La clé API est requise</small>
              }
              <small class="field-help">Cette clé sera utilisée par la borne pour communiquer avec le serveur</small>
            </div>
          </div>
        </p-card>

        <!-- Section localisation -->
        <p-card header="Localisation" styleClass="form-section">
          <ng-template pTemplate="header">
            <div class="section-header">
              <i class="pi pi-map-marker"></i>
              <span>Localisation</span>
            </div>
          </ng-template>
          
          <div class="form-grid">
            <!-- Localisation -->
            <div class="form-group col-12">
              <label for="localisation" class="required">Emplacement</label>
              <input 
                id="localisation" 
                type="text" 
                pInputText 
                formControlName="localisation"
                [class.ng-invalid]="isFieldInvalid('localisation')"
                placeholder="Ex: Salle principale, près de l'entrée"
                class="gaming-input" />
              @if (isFieldInvalid('localisation')) {
                <small class="p-error">La localisation est requise</small>
              }
            </div>

            <!-- Coordonnées GPS -->
            <div class="form-group col-6">
              <label for="latitude" class="required">Latitude</label>
              <input 
                id="latitude" 
                type="number" 
                pInputText 
                formControlName="latitude"
                [class.ng-invalid]="isFieldInvalid('latitude')"
                step="0.000001"
                placeholder="48.8566"
                class="gaming-input" />
              @if (isFieldInvalid('latitude')) {
                <small class="p-error">La latitude est requise (-90 à 90)</small>
              }
            </div>

            <div class="form-group col-6">
              <label for="longitude" class="required">Longitude</label>
              <input 
                id="longitude" 
                type="number" 
                pInputText 
                formControlName="longitude"
                [class.ng-invalid]="isFieldInvalid('longitude')"
                step="0.000001"
                placeholder="2.3522"
                class="gaming-input" />
              @if (isFieldInvalid('longitude')) {
                <small class="p-error">La longitude est requise (-180 à 180)</small>
              }
            </div>
          </div>
        </p-card>

        <!-- Section configuration des jeux -->
        <p-card header="Configuration des jeux" styleClass="form-section slots-section">
          <ng-template pTemplate="header">
            <div class="section-header">
              <i class="pi pi-gamepad"></i>
              <span>Configuration des jeux</span>
            </div>
          </ng-template>
          
          <div class="slots-configuration">
            <p class="section-description">
              Chaque borne dispose de 2 slots pour les jeux. Vous pouvez assigner un jeu différent à chaque slot ou laisser des slots libres.
            </p>
            
            <div formArrayName="slots" class="slots-grid">
              @for (slotControl of slotsArray.controls; track $index; let i = $index) {
                <div [formGroupName]="i" class="slot-card animate-scale-in" 
                     [style.animation-delay]="(i * 0.1) + 's'">
                  <div class="slot-header">
                    <div class="slot-number">
                      <span class="slot-label">Slot {{ i + 1 }}</span>
                      <div class="slot-indicator" [class]="getSlotIndicatorClass(i)">
                        <i [class]="getSlotIcon(i)"></i>
                      </div>
                    </div>
                    @if (getSelectedGameForSlot(i); as selectedGame) {
                      <div class="slot-status occupied">
                        <span class="status-label">Occupé</span>
                      </div>
                    } @else {
                      <div class="slot-status empty">
                        <span class="status-label">Libre</span>
                      }
                    }
                  </div>
                  
                  <div class="slot-content">
                    <div class="form-group">
                      <label [for]="'game_' + i">Jeu assigné</label>
                      <p-dropdown 
                        [id]="'game_' + i"
                        formControlName="game_id"
                        [options]="gameOptions()"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Sélectionner un jeu"
                        [showClear]="true"
                        styleClass="gaming-dropdown w-full"
                        (onChange)="onGameSlotChange(i, $event)">
                        
                        <ng-template pTemplate="selectedItem" let-option>
                          @if (option && option.game) {
                            <div class="selected-game">
                              <span class="game-name">{{ option.game.nom }}</span>
                              <span class="game-meta">{{ option.game.min_players }}-{{ option.game.max_players }} joueurs</span>
                            </div>
                          } @else {
                            <span class="no-game">Aucun jeu sélectionné</span>
                          }
                        </ng-template>
                        
                        <ng-template pTemplate="item" let-option>
                          @if (option.game) {
                            <div class="game-option">
                              <div class="game-info">
                                <span class="game-name">{{ option.game.nom }}</span>
                                <span class="game-description">{{ option.game.description || 'Aucune description' }}</span>
                              </div>
                              <div class="game-meta">
                                <span class="players">{{ option.game.min_players }}-{{ option.game.max_players }} joueurs</span>
                                <span class="cost">{{ option.game.ticket_cost }} tickets</span>
                              </div>
                            </div>
                          } @else {
                            <div class="no-game-option">
                              <i class="pi pi-times"></i>
                              <span>Aucun jeu</span>
                            </div>
                          }
                        </ng-template>
                      </p-dropdown>
                    </div>
                    
                    @if (getSelectedGameForSlot(i); as selectedGame) {
                      <div class="game-details animate-fade-in-up">
                        <div class="detail-item">
                          <i class="pi pi-users"></i>
                          <span>{{ selectedGame.min_players }}-{{ selectedGame.max_players }} joueurs</span>
                        </div>
                        <div class="detail-item">
                          <i class="pi pi-ticket"></i>
                          <span>{{ selectedGame.ticket_cost }} tickets</span>
                        </div>
                        @if (selectedGame.description) {
                          <div class="game-description">
                            <i class="pi pi-info-circle"></i>
                            <span>{{ selectedGame.description }}</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
            
            @if (hasSlotConflicts()) {
              <p-message severity="error" styleClass="slot-error animate-shake">
                <span>Erreur: Un même jeu ne peut pas être assigné à plusieurs slots</span>
              </p-message>
            }
          </div>
        </p-card>

        <!-- Erreurs de validation globales -->
        @if (formValidationErrors().length > 0) {
          <p-card styleClass="validation-errors-card animate-fade-in">
            <div class="validation-errors">
              <h4>
                <i class="pi pi-exclamation-triangle"></i>
                Erreurs de validation
              </h4>
              <ul>
                @for (error of formValidationErrors(); track error) {
                  <li>{{ error }}</li>
                }
              </ul>
            </div>
          </p-card>
        }

        <!-- Actions -->
        <div class="form-actions">
          <button 
            pButton 
            pRipple 
            type="button" 
            label="Annuler" 
            severity="secondary"
            outlined
            routerLink="/arcade-machines"
            class="action-btn">
          </button>
          
          @if (isEditMode()) {
            <button 
              pButton 
              pRipple 
              type="button" 
              label="Réinitialiser" 
              severity="warning"
              outlined
              (click)="resetForm()"
              class="action-btn">
            </button>
          }
          
          <button 
            pButton 
            pRipple 
            type="submit" 
            [label]="isEditMode() ? 'Mettre à jour' : 'Créer la borne'"
            [loading]="submitting()" 
            [disabled]="!canSubmit()"
            severity="success"
            class="gaming-button">
          </button>
        </div>
      </form>
    }
  </div>
</div>

<p-confirmDialog 
  header="Confirmation" 
  icon="pi pi-question-circle"
  styleClass="gaming-confirm-dialog">
</p-confirmDialog>